function add_sections_button_topbar(){const e=jQuery("#elementor-editor-wrapper-v2")[0],t=()=>{const e=jQuery(".MuiToolbar-root .MuiBox-root .MuiGrid-root:first-child .MuiStack-root:eq(1) .MuiBox-root:first-child button");if(e.length&&!jQuery("#twbb-custom-button").length){let t=jQuery("#twbb-sg-header-button-template").html();const n=jQuery(t).attr("id","twbb-custom-button");e.parent().after(n)}},n=new MutationObserver(((e,n)=>{e.forEach((e=>{"childList"===e.type&&t()}))}));n.observe(e,{childList:!0,subtree:!0}),setTimeout((()=>{n.disconnect()}),2e4),t()}function twbb_sections_reinstall(){jQuery.ajax({type:"POST",url:twbb_sg_editor.ajaxurl,dataType:"json",data:{action:"twbb_sections_reinstall",nonce:twbb_sg_editor.twbb_sg_nonce}}).success((function(e){e.success?setTimeout((function(){window.location.reload()}),3e3):(jQuery(document).find(".twbb-sg-sidebar-empty-loading-content").hide(),jQuery(document).find(".twbb-sg-sidebar-empty-error-content").show(),twbb_sg_editor.sections_exists="")})).error((function(){return jQuery(document).find(".twbb-sg-sidebar-empty-loading-content").hide(),jQuery(document).find(".twbb-sg-sidebar-empty-error-content").show(),!1}))}function twbb_create_preview_iframe(e,t,n){let i=e;if("ai-generated-sections"!==e){let e=jQuery(document).find("#twbb-sg-iframe-lazy-load-template").html();t.append(e),i="all"}if("ai-generated-sections"===e){let e='<iframe src="'+twbb_get_iframe_url(i).href+'" scrolling="no"></iframe>';t.append(e)}if("ai-generated-sections"!==e)if(void 0!==window.AllSectionsIframeContent&&""===jQuery("#twbb-sg-all-sections-iframe").contents().find("body").html()){injectIframeContent(document.getElementById("twbb-sg-all-sections-iframe"),window.AllSectionsIframeContent,e)}else{const n=()=>{let n=twbb_get_iframe_url(i);t.find("iframe").remove();let a='<iframe id="twbb-sg-all-sections-iframe" src="'+n.href+'" scrolling="no"></iframe>';t.append(a);var s=document.getElementById("twbb-sg-all-sections-iframe");s.onload=function(){setTimeout((function(){twbb_after_iframe_load(s,e)}),1e3)}};(()=>{let t=0;const i=setInterval((()=>{if(!window.AllSectionsIframeContentLoading||t>=30)if(void 0!==window.AllSectionsIframeContent&&jQuery("#twbb-sg-all-sections-iframe").contents().find("body").length&&""!==jQuery("#twbb-sg-all-sections-iframe").contents().find("body").html()){clearInterval(i),twbb_after_iframe_load(document.getElementById("twbb-sg-all-sections-iframe"),e)}else t>=30&&(clearInterval(i),n());t++}),100)})()}}function twbb_close_section_generation(){jQuery(".twbb-sg-header-button-container").removeClass("selected"),jQuery(".twbb-sg-sidebar").removeClass("twbb-animated-sidebar-show").addClass("twbb-animated-sidebar-hide"),jQuery("body").removeClass("twbb-sg-sidebar-opened")}function import_twbb_generated_template(e,t){var n=new(Backbone.Model.extend({defaults:{template_id:0,title:"",source:"",type:"",subtype:"",author:"",thumbnail:"",url:"",export_link:"",tags:[]}}))({});window.$e.run("document/elements/import",{model:n,data:t,options:{at:e,withPageSettings:null}}),"undefined"!=typeof coPilot&&void 0!==coPilot.newAddedWidgetModelId&&t&&t.content&&Array.isArray(t.content)&&t.content.length>0&&t.content[0]&&void 0!==t.content[0].id&&null!==t.content[0].id&&(coPilot.newAddedWidgetModelId=t.content[0].id)}function twbb_remove_iframe_in_process_classes(){jQuery(".twbb-sg-sidebar-navigated-contents-container .twbb-sg-sidebar-navigated-content iframe").contents().find(".twbb-sg-each-section").removeClass("twbb-the-sections-generation-in-process"),twbb_generate_with_ai_navigation_tab_status("enable"),jQuery(".twbb-sg-sidebar-navigated-contents-container").removeClass("twbb-some-section-in-process twbb-sg-generation-in-process"),jQuery(".twbb-sg-sidebar-navigated-contents-container .twbb-sg-sidebar-navigated-content iframe").each((function(){jQuery(this).contents().find("body").removeClass("twbb-some-section-in-process")}))}function twbb_remove_ai_generated_process_classes(){jQuery(".twbb-sg-sidebar-navigated-contents-container").removeClass("twbb-sg-generation-in-process twbb-some-section-in-process"),jQuery(".twbb-sg-sidebar-navigated-contents-container .twbb-sg-sidebar-navigated-content iframe").each((function(){jQuery(this).contents().find("body").removeClass("twbb-some-section-in-process")})),twbb_generate_with_ai_navigation_tab_status("enable"),jQuery(".twbb-sg-loading-container .step-4").removeClass("active")}function getTagTexts(e,t=["h1","h2","h3"]){let n={};return t.forEach((t=>{let i="";jQuery(e).find(t).each((function(){i+=jQuery(this).text()+","})),i.endsWith(",")&&(i=i.slice(0,-1)),""!==i&&(n[t]=i)})),n}function get_section_data(e,t){let n=e.children()[t],i={},a=jQuery("#elementor-preview-iframe");i.section_type="","header"===t?(i.section_type="header",a.contents().find('div[data-elementor-type="twbb_header"]>div[data-element_type="container"]:last-child').length?n=a.contents().find('div[data-elementor-type="twbb_header"]>div[data-element_type="container"]:last-child'):a.contents().find('div[data-elementor-type="twbb_header"]>.elementor-section-wrap>div[data-element_type="container"]:last-child').length&&(n=a.contents().find('div[data-elementor-type="twbb_header"]>.elementor-section-wrap>div[data-element_type="container"]:last-child'))):"footer"===t?(i.section_type="footer",a.contents().find('div[data-elementor-type="twbb_footer"]>div[data-element_type="container"]:first-child').length?n=a.contents().find('div[data-elementor-type="twbb_footer"]>div[data-element_type="container"]:first-child'):a.contents().find('div[data-elementor-type="twbb_footer"]>.elementor-section-wrap>div[data-element_type="container"]:first-child').length&&(n=a.contents().find('div[data-elementor-type="twbb_footer"]>.elementor-section-wrap>div[data-element_type="container"]:first-child'))):"last"===t&&(n=e.children()[e.children().length-1]),i.section_description="",i.section_title=getTagTexts(n),i.background_color=jQuery(n).css("background-color");let s="none";return jQuery(n).find(".elementor-background-slideshow").length?s="slider":jQuery(n).find("iframe.elementor-background-video-embed").length?s="video":"none"!==jQuery(n).css("background-image")&&(s="image"),i.background_media=s,i}function collect_data_for_request(e,t="",n=""){let i,a,s,o="",r=jQuery("#elementor-preview-iframe");return o=r.contents().find("head title").text(),i=r.contents().find("div.elementor.elementor-edit-area.elementor-edit-mode.elementor-edit-area-active div.elementor-section-wrap"),-1===e?(a=get_section_data(i,"last"),s=get_section_data(i,"footer")):0===e?(a=get_section_data(i,"header"),s=get_section_data(i,"last")):(a=get_section_data(i,e-1),s=get_section_data(i,e+1)),{current_section:{section_description:n,section_title:t,section_type:t},context:{page_title:o,previous_section:a,next_section:s,business_description:twbb_sg_editor.business_description,business_name:twbb_sg_editor.business_name,business_type:twbb_sg_editor.business_type}}}function move_progress_bar(e=0){if(0==e){e=1;var t=document.getElementById("loading-progress-bar"),n=1,i=setInterval((function(){n>=90?(clearInterval(i),e=0):(n++,t.style.width=n+"%")}),60)}let a=2,s=1;jQuery(".twbb-sg-loading-container .step-1").addClass("active");let o=setInterval((function(){a<5?(jQuery(".twbb-sg-loading-container .step-"+s).removeClass("active"),jQuery(".twbb-sg-loading-container .step-"+a).addClass("active"),a++,s++):clearInterval(o)}),2e3)}function set_content_generation_status(){let e=jQuery(".twbb-generate-section_description").val(),t=twbb_sg_editor.business_description;e||t?(e||t)&&(jQuery(".twbb-sg-sidebar-navigated-contents-container").hasClass("twbb-some-section-in-process")||jQuery(".twbb-sg-sidebar-navigated-content iframe").contents().find("body").hasClass("twbb-some-section-in-process")||jQuery(".twbb-sg-sidebar-navigated-content-header-button.twbb-sg-generate-with-ai-button").removeClass("disabled")):jQuery(".twbb-sg-sidebar-navigated-content-header-button.twbb-sg-generate-with-ai-button").hasClass("disabled")||jQuery(".twbb-sg-sidebar-navigated-content-header-button.twbb-sg-generate-with-ai-button").addClass("disabled")}function scroll_to_editable_element(){let e=jQuery("#elementor-preview-iframe").contents();if(e.find(".elementor-element-editable").length){"undefined"!=typeof coPilot&&"undefined"!==coPilot.newAddedWidgetModelId&&(coPilot.newAddedWidgetModelId=e.find(".elementor-element-editable").attr("data-id"));var t=e.find(".elementor-element-editable").offset().top-100;e.find("html,body").animate({scrollTop:t},1e3)}}function twbb_insert_section_premade(e,t){jQuery.ajax({type:"POST",url:twbb_sg_editor.ajaxurl,dataType:"json",data:t}).success((function(t){"success"===t.data.status&&(import_twbb_generated_template(e,t.data.params),twbb_remove_iframe_in_process_classes(),scroll_to_editable_element(),"function"==typeof window.twbUpdateTrialLimitation&&twbUpdateTrialLimitation())})).error((function(){console.log("Something Wrong when getting generated section data for request."),twbb_remove_iframe_in_process_classes()}))}function twbb_generate_with_ai_navigation_tab_status(e=""){"disable"===e?(jQuery(".twbb-sg-sidebar-navigated-content-header-button.twbb-sg-generate-with-ai-button").addClass("disabled"),jQuery(".twbb-sg-sidebar-generated-with-ai .custom-select-container").addClass("is-disabled"),jQuery(".twbb-sg-sidebar-generated-with-ai textarea").attr("disabled",!0),jQuery(".twbb-generate-with-ai-iframes iframe").length||jQuery(".twbb-generate-not-available").css("display","flex")):(jQuery(".twbb-sg-sidebar-navigated-content-header-button.twbb-sg-generate-with-ai-button").removeClass("disabled"),jQuery(".twbb-sg-sidebar-generated-with-ai .custom-select-container").removeClass("is-disabled"),jQuery(".twbb-sg-sidebar-generated-with-ai textarea").attr("disabled",!1),jQuery(".twbb-generate-not-available").css("display","none"))}function twbb_trigger_sections_button(e){if(e.hasClass("disabled"))return;if(e.hasClass("selected")&&jQuery(document).find(".twbb-sg-sidebar").hasClass("twbb-animated-sidebar-show"))return void twbb_animate_sidebar("close",jQuery(".twbb-sg-sidebar"),522,"twbb-sg-sidebar-opened",twbb_close_section_generation);if(!twbb_options.show_ultimate_kit&&"undefined"!=typeof theme_Customize)return theme_Customize.openCustomizeEnablePopup(),!1;if(e.addClass("selected"),jQuery(".MuiToolbar-root .MuiBox-root .MuiGrid-root:first-child .MuiStack-root:eq(1) .MuiBox-root:first-child button").removeClass("Mui-selected"),!jQuery(".twbb-sg-sidebar").length){let e=jQuery("#twbb-sg-sidebar-template").html();jQuery("#elementor-editor-wrapper-v2").append(e),jQuery("#twbb-select-generate-section_types").customSelect()}void 0!==window.AllSectionsIframeContent&&""===jQuery("#twbb-sg-all-sections-iframe").contents().find("body").html()&&injectIframeContent(document.getElementById("twbb-sg-all-sections-iframe"),window.AllSectionsIframeContent,"all");"function"==typeof window.twbAddTrialFlowTooltip&&twbAddTrialFlowTooltip(),jQuery("#twbb-select-generate-section_types").customSelect(),twbb_animate_sidebar("open",jQuery(".twbb-sg-sidebar"),522,"twbb-sg-sidebar-opened",twbb_close_section_generation),jQuery(".twbb-sg-sidebar-generated-with-ai").hasClass(".selected")||jQuery('.twbb-sg-navigation-item[data-type="generate-with-ai"]').trigger("click"),"no"==twbb_sg_editor.sections_exists&&twbb_sections_reinstall()}function preloadIframeContent(e){return new Promise(((t,n)=>{const i=new Worker(twbb_editor.plugin_url+"/Apps/SectionGeneration/assets/script/iframe-preload-worker.js");i.onmessage=function(e){"success"===e.data.type?t(e.data.content):"error"===e.data.type&&n(new Error(e.data.error)),i.terminate()},i.onerror=function(e){n(e),i.terminate()};const a=e.toString();i.postMessage({type:"preload",url:a})}))}function injectIframeContent(e,t,n){const i=e.contentDocument||e.contentWindow.document;i.open(),i.write(t),i.close()}async function twbb_preload_sections_iframe_content(){window.AllSectionsIframeContentLoading=!0;let e=twbb_get_iframe_url("all");try{const n=await preloadIframeContent(e);function t(){if(!jQuery(".twbb-sg-sidebar").length){let e=jQuery("#twbb-sg-sidebar-template").html();jQuery("#elementor-editor-wrapper-v2").append(e),jQuery("#twbb-select-generate-section_types").customSelect()}void 0!==window.AllSectionsIframeContent&&""===jQuery("#twbb-sg-all-sections-iframe").contents().find("body").html()&&(injectIframeContent(document.getElementById("twbb-sg-all-sections-iframe"),window.AllSectionsIframeContent,"all"),jQuery(".twbb-sg-sidebar-opened").length||jQuery(".twbb-sg-sidebar").removeClass("twbb-animated-sidebar-show").addClass("twbb-animated-sidebar-hide"),window.AllSectionsIframeContentLoading=!1)}window.AllSectionsIframeContent=n,elementor?elementor.loaded?t():elementor.hooks.addAction("preview:loaded",t):jQuery(window).on("elementor:init",(function(){elementor.hooks.addAction("preview:loaded",t)}))}catch(i){console.error("Error preloading iframe content:",i),window.AllSectionsIframeContentLoading=!1}}function twbb_after_iframe_load(e,t){jQuery(e).contents().find("body").attr("data-twbb-please-show-sections",t);var n=jQuery(e).contents().find("body").attr("data-twbb-please-show-sections");twbb_sg_editor.woocommerceActiveStatus&&jQuery(e).contents().find("body").addClass("twbb-show-woocommerce-sections"),jQuery(document).find(".twbb-sg-iframe-lazy-load-layer, .twbb-sg-iframe-lazy-load-container").remove(),jQuery(e).contents().find('.twbb-sg-each-section[id*="'+n+'"]').addClass("twbb-visible")}function twbb_get_iframe_url(e){let t=new URL(twbb_editor.page_permalink);return t.searchParams.set("twbb_sg_preview","generated_sections_"+e),t.searchParams.set("twbb_template_preview",e),t.searchParams.set("twbb_template_preview_from",twbb_editor.post_id),t.searchParams.set("twbb_template_preview_nonce",twbb_editor.template_preview_nonce),t}jQuery(document).ready((function(){twbb_preload_sections_iframe_content(),jQuery(document).on("click","#elementor-mode-switcher",(function(){jQuery("body").hasClass("elementor-editor-preview")?(jQuery(".twbb-sg-header-button-container").removeClass("disabled"),jQuery(".twbb-customize-button").removeClass("disabled")):(jQuery(".twbb-sg-header-button-container").hasClass("disabled")||jQuery(".twbb-sg-header-button-container").addClass("disabled"),jQuery(".twbb-customize-button").hasClass("disabled")||jQuery(".twbb-customize-button").addClass("disabled"))})),jQuery(document).on("input",".twbb-generate-section_description",(function(){set_content_generation_status()}));let e=jQuery("#tmpl-elementor-add-section");if(0<e.length){var t=e.html();t=t.replace('<div class="e-view elementor-add-new-section">','<div class="e-view elementor-add-new-section"><div class="elementor-add-section-area-button elementor-add-twbb-section-generation-button">Add Section</div>'),e.html(t)}"not_passed"===twbb_sg_editor.sections_new&&jQuery("header").addClass("twbb-new-section-generation");let n=jQuery("#twbb-sg-sidebar-generated-with-ai_overlay-template").html();add_sections_button_topbar(),jQuery("document").on("click",".custom-select-container.is-disabled",(function(e){e.stopPropagation()})),jQuery(document).on("click",".twbb-sg-header-button-container",(function(){jQuery(this).hasClass("disabled")||jQuery(this).hasClass("selected")||analyticsDataPush("Add Section","Section Generation","Topbar"),twbb_trigger_sections_button(jQuery(this))})),jQuery(document).on("click",".twbb-sg-navigation-item",(function(){let e=jQuery(".twbb-sg-navigation-item.selected").attr("data-type");"generate-with-ai"==jQuery(this).attr("data-type")&&(jQuery(".twbb-generate-with-ai-button-input").parent().animate({scrollTop:0},1e3),jQuery(this).hasClass("twbb-sg-sidebar-navigator-menu-li")&&(e="other")),jQuery(".twbb-sg-navigation-item").removeClass("selected");let t=jQuery(this).attr("data-type"),n=jQuery(this).attr("data-post_id");jQuery(".twbb-sg-navigation-item[data-type="+t+"]").addClass("selected");var i=jQuery('.twbb-sg-sidebar-navigated-contents-container .twbb-sg-sidebar-navigated-content[data-type="all"]');if(jQuery(".twbb-sg-sidebar-navigated-contents-container .twbb-sg-sidebar-navigated-content.selected").removeClass("selected"),"generate-with-ai"!==t){jQuery(".twbb-sg-sidebar-navigated-contents-container").removeClass("twbb-sg-sidebar-navigated-contents-container-ai-generated"),""!==i.find("iframe").contents().find("body").html()&&""!==i.html()||twbb_create_preview_iframe(t,i,n),i.find("iframe").contents().find("body").attr("data-twbb-please-show-sections",t);i.find("iframe").contents().find("body").attr("data-twbb-please-show-sections");i.find("iframe").contents().find(".twbb-sg-each-section").removeClass("twbb-visible"),i.find("iframe").contents().find("body").attr("data-twbb-please-show-sections",t),i.find("iframe").contents().find('.twbb-sg-each-section[id*="/'+t+'/"]').addClass("twbb-visible"),i.find("iframe").contents().find("html, body").animate({scrollTop:0},"slow"),i.find("iframe").each((function(){const e=this.contentWindow;e&&e.dispatchEvent(new Event("resize"))}))}else jQuery(".twbb-sg-sidebar-navigated-contents-container").addClass("twbb-sg-sidebar-navigated-contents-container-ai-generated"),jQuery('.custom-select-panel .custom-select-option[data-value="'+e+'"]').trigger("click");i.addClass("selected"),i.attr("style","height:calc( 100% + 90px - "+i.offset().top+"px)"),i.find("iframe").attr("style","height:calc( 4 * "+i.height()+"px)")})),jQuery(document).on("click",".twbb-sg-generate-with-ai-button",(function(){if("function"==typeof window.twbShowTrialFlowCreditsExpired&&!twbShowTrialFlowCreditsExpired())return;if(jQuery(this).hasClass("disabled")||jQuery(".twbb-sg-sidebar-navigated-contents-container").hasClass("twbb-some-section-in-process")||jQuery(".twbb-sg-sidebar-navigated-content iframe").contents().find("body").hasClass("twbb-some-section-in-process"))return;jQuery(this).addClass("disabled");let e,t,i=-1;e=jQuery(".twbb-sg-sidebar-generated-with-ai .custom-select-panel .custom-select-option.is-selected").attr("data-value");let a=Math.random().toString(36).slice(2,10);jQuery(".twbb-sg-sidebar-generated-with-ai").attr("data-unique_id",a),analyticsDataPush("Generate With AI Button from sidebar","Section Generation",e,{unique_id:a}),t=jQuery(".twbb-generate-section_description").val(),jQuery("#elementor-preview-iframe").contents().find(".elementor-add-section:not(#elementor-add-new-section)").length&&(i=jQuery("#elementor-preview-iframe").contents().find(".elementor-add-section:not(#elementor-add-new-section)").index());let s=collect_data_for_request(i,e,t);jQuery(".twbb-sg-sidebar-navigated-contents-container").addClass("twbb-some-section-in-process twbb-sg-generation-in-process"),jQuery(".twbb-sg-sidebar-navigated-contents-container .twbb-sg-sidebar-navigated-content iframe").each((function(){jQuery(this).contents().find("body").addClass("twbb-some-section-in-process")})),jQuery(".twbb-sg-loading-container .step-4").removeClass("active"),jQuery(".twbb-sg-sidebar-generated-with-ai_overlay").length||jQuery(".twbb-sg-sidebar-generated-with-ai").append(n),move_progress_bar(0);var o={closest_sections_data:JSON.stringify(s),user_description:t,section_type:e,action:"twbb_generate_with_ai_section_template",nonce:twbb_sg_editor.twbb_sg_nonce,unique_id:a};jQuery.ajax({type:"POST",url:twbb_sg_editor.ajaxurl,dataType:"json",data:o}).success((function(e){if("success"===e.data.status){"function"==typeof window.twbUpdateTrialLimitation&&twbUpdateTrialLimitation();let i=jQuery(".twbb-generate-with-ai-iframes");if(i.length){i.html(""),twbb_create_preview_iframe("ai-generated-sections",i,e.data.post_id),jQuery(".twbb-ready-text").css("display","block"),i.find("iframe").on("load",(function(){twbb_remove_ai_generated_process_classes()}));let a=jQuery(".twbb-generate-with-ai-button-input");if(a.length){var t=a.parent(),n=a.offset().top-t.offset().top-50;n>0&&t.animate({scrollTop:n},1e3)}}}})).error((function(){console.log("Something Wrong when getting generated section data for request.")}))})),jQuery(document).on("keyup",".twbb-generate-section_description",(function(){jQuery(this).val().length>=1e3?jQuery(".char-limit-warning").show():jQuery(".char-limit-warning").hide()}))}));